name: Gold Drawings Processing

on:
  pull_request:
    branches: [ main, issue-* ]

jobs:
  process-gold-images:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0 # To fetch all history for all branches and tags. Needed for git diff.

      # debug info to run locally with 'act'. It shows secrets!!
      #- name: Dump context
      #  uses: crazy-max/ghaction-dump-context@v1

      - name: Setup DVC
        uses: iterative/setup-dvc@v1

      - name: Pull images from remote storage
        env:
          AZURE_STORAGE_ACCOUNT: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
          AZURE_STORAGE_SAS_TOKEN: ${{ secrets.AZURE_STORAGE_SAS_TOKEN }}
        run: dvc pull --remote azure

      - name: Debug env vars
        shell: bash
        run: |
          # https://docs.github.com/en/actions/learn-github-actions/environment-variables#default-environment-variables
          echo -e "GITHUB_WORKSPACE: $GITHUB_WORKSPACE\n"
          echo -e "GITHUB_SHA: $GITHUB_SHA\n"
          echo -e "GITHUB_REF: $GITHUB_REF\n"
          echo -e "GITHUB_HEAD_REF: $GITHUB_HEAD_REF\n"
          echo -e "GITHUB_BASE_REF: $GITHUB_BASE_REF\n"
          echo -e "GITHUB_EVENT_NAME: $GITHUB_EVENT_NAME\n"
          echo -e "GITHUB_EVENT_PATH: $GITHUB_EVENT_PATH\n" 
          #cat $GITHUB_EVENT_PATH

      - name: Set env (local)
        if: ${{ env.ACT }} # GITHUB_HEAD_REF & GITHUB_BASE_REF are empty using act
        run: |
          echo "PREVIOUS_REF=HEAD" >> $GITHUB_ENV
          echo "CURRENT_REF=" >> $GITHUB_ENV

      - name: Set env (runner)
        if: ${{ !env.ACT }} # GITHUB_HEAD_REF & GITHUB_BASE_REF are empty using act
        run: |
          echo "PREVIOUS_REF=origin/${{ github.base_ref }}" >> $GITHUB_ENV
          echo "CURRENT_REF=HEAD" >> $GITHUB_ENV

      - name: Git diff
        run: |
          git show-ref
          echo "git --no-pager diff ${{ env.PREVIOUS_REF }} ${{ env.CURRENT_REF }}"
          git --no-pager diff ${{ env.PREVIOUS_REF }} ${{ env.CURRENT_REF }}

      - name: DVC diff
        id: dvc-diff
        uses: ./.github/actions/dvc-diff
        env:
          DVC_REPO_DIR: "${{ github.workspace }}"

      - name: Debug diff ouput
        run: |
          echo "The diff output is: ${{ steps.dvc-diff.outputs.diff }}"

      - name: Validate filenames (act)
        if: ${{ env.ACT }}
        uses: ./.github/actions/validate-filenames
        with:
          filenames: '{"added": [{"path": "data/000001/32/000001-32.600.2.tif"}], "deleted": [], "modified": [], "renamed": [], "not in cache": []}'

      - name: Validate filenames (runner)
        if: ${{ !env.ACT }}
        uses: ./.github/actions/validate-filenames
        with:
          filenames: ${{ steps.dvc-diff.outputs.diff }}

      - name: Validate Gold images folder (act)
        if: ${{ env.ACT }}
        uses: ./.github/actions/validate-gold-image-folder
        with:
          filepaths: '{"added": [{"path": "data/000001/32/000001-32.600.2.tif"}], "deleted": [], "modified": [], "renamed": [], "not in cache": []}'

      - name: Validate Gold images folder (runner)
        if: ${{ !env.ACT }}
        uses: ./.github/actions/validate-gold-image-folder
        with:
          filepaths: ${{ steps.dvc-diff.outputs.diff }}

      - name: Validate Gold images sizes (act)
        if: ${{ env.ACT }}
        uses: ./.github/actions/validate-image-size
        with:
          dvc_diff: '{"added": [{"path": "data/000001/32/000001-32.600.2.tif"}], "modified": [], "renamed": [], "not in cache": []}'
          min_size: 320
          max_size: 340000

      - name: Resize gold images (act)
        uses: ./.github/actions/resize-image
        id: resize
        with:
          dvc_diff: '{"added": [{"path": "data/000001/32/000001-32.600.2.tif"}], "modified": [], "renamed": [], "not in cache": []}'
          width: 320
          height: 200

      - name: Change image profile
        uses: ./.github/actions/modify-image-icc-profile
        id: icc-modification
        with:
          state: '${{ steps.resize.outputs.result }}'
          profile: sRGB

      - name: Change image format
        uses: ./.github/actions/change-image-file-format
        id: change-format
        with:
          state: '${{ steps.icc-modification.outputs.result }}'
          format: jpg

      - name: Copy to final folder
        uses: ./.github/actions/copy-to-base-folder
        id: copy-base-folder
        with:
          state: '${{ steps.change-format.outputs.result }}'

      - name: Commit file
        uses: ./.github/actions/auto-commit-push
        id: auto-commit-push
        env:
          FILENAMES: '${{ steps.copy-base-folder.outputs.result }}'
          MESSAGE: 'Update processed base images'
          TEST: 'TRUE'
